#!/bin/bash

# ====================================================
# Remote Tunnel - 统一管理命令
# 支持多种内网穿透方案
# ====================================================

set -e

# 获取脚本目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# 加载配置
CONFIG_FILE="${PROJECT_ROOT}/config/tunnel.conf"
if [[ -f "${CONFIG_FILE}" ]]; then
    source "${CONFIG_FILE}"
fi

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# 默认方法
METHOD="${DEFAULT_METHOD:-frp}"

# ====================================================
# 函数定义
# ====================================================

# 显示 logo
show_logo() {
    cat << "EOF"
╔═══════════════════════════════════════╗
║                                       ║
║      Remote Tunnel Manager           ║
║      内网穿透管理工具                 ║
║                                       ║
╚═══════════════════════════════════════╝
EOF
    echo ""
}

# 显示帮助
show_help() {
    show_logo
    cat << EOF
用法: remote-tunnel [命令] [选项]

命令:
  up          启动隧道（默认使用 ${DEFAULT_METHOD}）
  down        停止隧道
  restart     重启隧道
  status      查看状态
  logs        查看日志
  test        测试服务器连接
  switch      切换隧道方案
  config      编辑配置文件
  doctor      诊断问题

方法选项（可选）:
  --frp       使用 frp 方案
  --ssh       使用 SSH 反向隧道

示例:
  remote-tunnel up            # 使用默认方案启动
  remote-tunnel up --frp      # 使用 frp 启动
  remote-tunnel up --ssh      # 使用 SSH 启动
  remote-tunnel status        # 查看状态
  remote-tunnel down          # 停止隧道

配置:
  配置文件: ${CONFIG_FILE}
  服务器: ${SERVER_HOST:-未配置}
  本地端口: ${LOCAL_PORT:-未配置}
  远程端口: ${REMOTE_PORT:-未配置}

更多帮助: remote-tunnel help [命令]
EOF
}

# 检测方法参数
detect_method() {
    for arg in "$@"; do
        case $arg in
            --frp)
                METHOD="frp"
                ;;
            --ssh)
                METHOD="ssh"
                ;;
        esac
    done
}

# 启动隧道
tunnel_up() {
    detect_method "$@"

    echo -e "${CYAN}→${NC} 启动隧道（方法: ${METHOD}）..."
    echo ""

    case ${METHOD} in
        frp)
            "${PROJECT_ROOT}/scripts/frp/client.sh" start
            ;;
        ssh)
            "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" start
            ;;
        *)
            echo -e "${RED}✗${NC} 未知的隧道方法: ${METHOD}"
            echo "支持的方法: frp, ssh"
            exit 1
            ;;
    esac
}

# 停止隧道
tunnel_down() {
    echo -e "${CYAN}→${NC} 停止所有隧道..."
    echo ""

    # 尝试停止所有可能运行的隧道
    "${PROJECT_ROOT}/scripts/frp/client.sh" stop 2>/dev/null || true
    "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" stop 2>/dev/null || true

    echo -e "${GREEN}✓${NC} 所有隧道已停止"
}

# 重启隧道
tunnel_restart() {
    detect_method "$@"

    echo -e "${CYAN}→${NC} 重启隧道（方法: ${METHOD}）..."
    echo ""

    case ${METHOD} in
        frp)
            "${PROJECT_ROOT}/scripts/frp/client.sh" restart
            ;;
        ssh)
            "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" restart
            ;;
        *)
            echo -e "${RED}✗${NC} 未知的隧道方法: ${METHOD}"
            exit 1
            ;;
    esac
}

# 查看状态
tunnel_status() {
    show_logo

    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    echo -e "${BLUE}frp 隧道${NC}"
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    "${PROJECT_ROOT}/scripts/frp/client.sh" status 2>/dev/null || echo "未运行"

    echo ""
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    echo -e "${BLUE}SSH 隧道${NC}"
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" status 2>/dev/null || echo "未运行"

    echo ""
}

# 查看日志
tunnel_logs() {
    detect_method "$@"

    case ${METHOD} in
        frp)
            "${PROJECT_ROOT}/scripts/frp/client.sh" logs
            ;;
        ssh)
            "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" logs
            ;;
        *)
            echo -e "${YELLOW}显示所有日志:${NC}"
            echo ""
            echo "=== frp 日志 ==="
            "${PROJECT_ROOT}/scripts/frp/client.sh" logs 2>/dev/null || echo "无日志"
            echo ""
            echo "=== SSH 隧道日志 ==="
            "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" logs 2>/dev/null || echo "无日志"
            ;;
    esac
}

# 测试连接
tunnel_test() {
    show_logo

    echo -e "${CYAN}→${NC} 测试服务器连接..."
    echo ""

    # 测试基本网络
    echo "1. 测试基本网络连接:"
    if ping -c 1 ${SERVER_HOST} &> /dev/null; then
        echo -e "   ${GREEN}✓${NC} 服务器 ${SERVER_HOST} 可达"
    else
        echo -e "   ${RED}✗${NC} 无法 ping 通服务器"
    fi

    echo ""
    echo "2. 测试 SSH 连接:"
    "${PROJECT_ROOT}/scripts/ssh/tunnel.sh" test || true

    echo ""
    echo "3. 测试 frp 端口:"
    "${PROJECT_ROOT}/scripts/frp/client.sh" test || true

    echo ""
}

# 切换方案
tunnel_switch() {
    show_logo

    echo -e "${BLUE}当前方案: ${METHOD}${NC}"
    echo ""
    echo "可用方案:"
    echo "  1) frp"
    echo "  2) ssh"
    echo ""
    read -p "请选择 (1-2): " choice

    case $choice in
        1)
            NEW_METHOD="frp"
            ;;
        2)
            NEW_METHOD="ssh"
            ;;
        *)
            echo -e "${RED}✗${NC} 无效选择"
            exit 1
            ;;
    esac

    # 更新配置文件
    if [[ -f "${CONFIG_FILE}" ]]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/DEFAULT_METHOD=\".*\"/DEFAULT_METHOD=\"${NEW_METHOD}\"/" "${CONFIG_FILE}"
        else
            sed -i "s/DEFAULT_METHOD=\".*\"/DEFAULT_METHOD=\"${NEW_METHOD}\"/" "${CONFIG_FILE}"
        fi
        echo -e "${GREEN}✓${NC} 默认方案已切换为: ${NEW_METHOD}"
    fi
}

# 编辑配置
edit_config() {
    if [[ ! -f "${CONFIG_FILE}" ]]; then
        echo -e "${RED}✗${NC} 配置文件不存在: ${CONFIG_FILE}"
        exit 1
    fi

    # 选择编辑器
    EDITOR=${EDITOR:-nano}
    if ! command -v ${EDITOR} &> /dev/null; then
        EDITOR=vi
    fi

    ${EDITOR} "${CONFIG_FILE}"
}

# 诊断问题
doctor() {
    show_logo

    echo -e "${CYAN}→${NC} 诊断系统..."
    echo ""

    local errors=0

    # 检查配置文件
    echo "1. 检查配置文件:"
    if [[ -f "${CONFIG_FILE}" ]]; then
        echo -e "   ${GREEN}✓${NC} 配置文件存在"

        # 检查必要配置项
        if grep -q "SERVER_HOST=" "${CONFIG_FILE}"; then
            SERVER_HOST=$(grep "SERVER_HOST=" "${CONFIG_FILE}" | cut -d'"' -f2)
            echo -e "   ${GREEN}✓${NC} 服务器地址: ${SERVER_HOST}"
        else
            echo -e "   ${RED}✗${NC} 缺少 SERVER_HOST 配置"
            errors=$((errors + 1))
        fi

        if grep -q "LOCAL_PORT=" "${CONFIG_FILE}"; then
            LOCAL_PORT=$(grep "LOCAL_PORT=" "${CONFIG_FILE}" | cut -d'"' -f2)
            echo -e "   ${GREEN}✓${NC} 本地端口: ${LOCAL_PORT}"
        else
            echo -e "   ${RED}✗${NC} 缺少 LOCAL_PORT 配置"
            errors=$((errors + 1))
        fi
    else
        echo -e "   ${RED}✗${NC} 配置文件不存在"
        errors=$((errors + 1))
    fi

    echo ""
    echo "2. 检查依赖工具:"

    # SSH
    if command -v ssh &> /dev/null; then
        echo -e "   ${GREEN}✓${NC} ssh 已安装"
    else
        echo -e "   ${RED}✗${NC} ssh 未安装"
        errors=$((errors + 1))
    fi

    # curl/wget
    if command -v curl &> /dev/null; then
        echo -e "   ${GREEN}✓${NC} curl 已安装"
    elif command -v wget &> /dev/null; then
        echo -e "   ${GREEN}✓${NC} wget 已安装"
    else
        echo -e "   ${RED}✗${NC} curl 或 wget 未安装"
        errors=$((errors + 1))
    fi

    echo ""
    echo "3. 检查本地服务:"
    if command -v nc &> /dev/null || command -v netcat &> /dev/null; then
        if nc -zv localhost ${LOCAL_PORT} 2>&1 | grep -q succeeded; then
            echo -e "   ${GREEN}✓${NC} 本地端口 ${LOCAL_PORT} 正在监听"
        else
            echo -e "   ${YELLOW}⚠${NC}  本地端口 ${LOCAL_PORT} 未监听（需要先启动 PowerConnect）"
        fi
    else
        echo -e "   ${YELLOW}⚠${NC}  netcat 未安装，无法检查端口"
    fi

    echo ""
    echo "4. 检查网络连接:"
    if ping -c 1 ${SERVER_HOST:-8.8.8.8} &> /dev/null; then
        echo -e "   ${GREEN}✓${NC} 网络连接正常"
    else
        echo -e "   ${RED}✗${NC} 网络连接异常"
        errors=$((errors + 1))
    fi

    echo ""
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    if [[ $errors -eq 0 ]]; then
        echo -e "${GREEN}✓${NC} 系统检查完成，未发现问题"
    else
        echo -e "${YELLOW}⚠${NC}  发现 ${errors} 个问题，请检查"
    fi
    echo ""
}

# ====================================================
# 主逻辑
# ====================================================

case "${1:-}" in
    up|start)
        shift
        tunnel_up "$@"
        ;;
    down|stop)
        tunnel_down
        ;;
    restart)
        shift
        tunnel_restart "$@"
        ;;
    status)
        tunnel_status
        ;;
    logs|log)
        shift
        tunnel_logs "$@"
        ;;
    test)
        tunnel_test
        ;;
    switch)
        tunnel_switch
        ;;
    config)
        edit_config
        ;;
    doctor|check)
        doctor
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        echo "Remote Tunnel v1.0.0"
        ;;
    *)
        show_help
        exit 1
        ;;
esac
